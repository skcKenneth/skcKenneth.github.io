<script src="{{ base_path }}/assets/js/main.min.js"></script>

<!-- Fix Kramdown math issues and reprocess with MathJax -->
<script>
(function() {
  function fixAndReprocessMath() {
    if (!document.body) return;
    
    // Function to fix math content
    function fixMath(math) {
      // Fix double backslashes: \\theta -> \theta (but preserve \\\\ for line breaks)
      math = math.replace(/\\\\([a-zA-Z@{}[\]]+|\\[a-zA-Z]+)/g, function(m) {
        if (m === '\\\\\\\\') return m;
        return m.replace(/^\\\\/, '\\');
      });
      // Fix escaped underscores and braces
      math = math.replace(/\\_/g, '_').replace(/\\{/g, '{').replace(/\\}/g, '}');
      return math.trim();
    }
    
    // Process the entire body HTML
    let html = document.body.innerHTML;
    const original = html;
    
    // Process inline math: $ ... $ or $...$ -> $...$ (no spaces for MathJax)
    html = html.replace(/\$\s*([^$\n]+?)\s*\$/g, function(match, math) {
      return '$' + fixMath(math) + '$';
    });
    
    // Process display math: $$ ... $$ or $$...$$ -> $$...$$
    html = html.replace(/\$\$\s*([^$]+?)\s*\$\$/g, function(match, math) {
      return '$$' + fixMath(math) + '$$';
    });
    
    // Only update if changed
    if (html !== original) {
      // Clear any existing MathJax output
      if (window.MathJax && window.MathJax.startup && window.MathJax.startup.document) {
        const mathElements = document.querySelectorAll('.MathJax, [id^="MathJax"]');
        mathElements.forEach(function(el) {
          if (el.parentNode) {
            const textNode = document.createTextNode(el.textContent || el.innerText);
            el.parentNode.replaceChild(textNode, el);
          }
        });
      }
      
      // Update HTML
      document.body.innerHTML = html;
      
      // Reprocess with MathJax
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise().catch(function(err) {
          console.error('MathJax reprocessing error:', err);
        });
      }
    }
  }
  
  // Wait for MathJax to load, then fix and reprocess
  function waitForMathJax() {
    if (window.MathJax && window.MathJax.startup) {
      window.MathJax.startup.promise.then(function() {
        setTimeout(fixAndReprocessMath, 100);
      }).catch(function() {
        // If promise fails, try anyway
        setTimeout(fixAndReprocessMath, 500);
      });
    } else {
      // Check again after a delay
      setTimeout(waitForMathJax, 100);
    }
  }
  
  // Start waiting when page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForMathJax);
  } else {
    waitForMathJax();
  }
})();
</script>

{% include analytics.html %}
{% include /comments-providers/scripts.html %}
